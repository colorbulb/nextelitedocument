rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - allow read for authenticated users
    // Teachers need to read all users to manage student access to documents
    // Since users created in nextelitebackend are valid across all apps, we allow authenticated users to read
    match /users/{userId} {
      allow read, list: if request.auth != null; // Allow all authenticated users to read (needed for student queries)
      allow write: if false; // Only backend can write to users
    }
    
    // Courses collection - authenticated users can read and write
    // Note: App-level check ensures only teachers can access the portal
    match /courses/{courseId} {
      allow read, list: if request.auth != null;
      allow create, update, delete: if request.auth != null;
      
      // Levels subcollection
      match /levels/{levelId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if request.auth != null;
        
        // Lessons subcollection
        match /lessons/{lessonId} {
          allow read, list: if request.auth != null;
          allow create, update, delete: if request.auth != null;
          
          // Documents subcollection for view logs
          match /documents/{documentId} {
            match /viewLogs/{logId} {
              allow read, list: if request.auth != null;
              allow create: if request.auth != null;
            }
          }
        }
      }
    }
    
    // Document view logs collection
    match /documentViewLogs/{logId} {
      allow read, list: if request.auth != null;
      allow create: if request.auth != null;
    }
    
    // Classes collection (for NextElite import - read only)
    match /classes/{classId} {
      allow read, list: if request.auth != null;
      allow write: if false;
    }
  }
}

